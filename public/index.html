<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººç·šä¸ŠæŠ½ç±¤ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .room-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .room-info h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .room-info p {
            color: #666;
            margin: 5px 0;
        }
        
        .participants {
            margin: 20px 0;
        }
        
        .participants h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .participant {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .participant.host {
            background: #fff3e0;
        }
        
        .participant.offline {
            opacity: 0.5;
        }
        
        .participant.winner {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .participant-name {
            font-weight: 500;
            color: #333;
        }
        
        .participant-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .status-dot.offline {
            background: #bdbdbd;
        }
        
        .kick-btn {
            padding: 4px 8px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        
        .input-section h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .input-section p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .number-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .number-input input {
            width: 100px;
        }
        
        .result-section {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            text-align: center;
        }
        
        .result-section h3 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .result-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .winner-name {
            font-size: 28px;
            font-weight: bold;
            color: #2e7d32;
            margin: 10px 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .controls button {
            flex: 1;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥ç•«é¢ -->
        <div id="loginScreen">
            <h1>ğŸ² å¤šäººç·šä¸ŠæŠ½ç±¤ç³»çµ±</h1>
            <div class="login-form">
                <input type="text" id="roomName" placeholder="è¼¸å…¥æˆ¿é–“åç¨±" maxlength="20">
                <input type="text" id="userName" placeholder="è¼¸å…¥ä½ çš„åå­—" maxlength="20">
                <button onclick="joinRoom()">é€²å…¥æˆ¿é–“</button>
                <div id="loginError" class="error hidden"></div>
            </div>
        </div>
        
        <!-- æˆ¿é–“ç•«é¢ -->
        <div id="roomScreen" class="hidden">
            <div class="room-info">
                <h2>æˆ¿é–“ï¼š<span id="currentRoom"></span></h2>
                <p>ç‹€æ…‹ï¼š<span id="roomPhase"></span></p>
                <p id="hostInfo"></p>
            </div>
            
            <!-- åƒèˆ‡è€…åˆ—è¡¨ -->
            <div class="participants">
                <h3>åƒèˆ‡è€… (<span id="participantCount">0</span>)</h3>
                <div id="participantList" class="participant-list"></div>
            </div>
            
            <!-- å¾…æ©Ÿéšæ®µæ§åˆ¶ -->
            <div id="lobbyControls" class="controls hidden">
                <button onclick="startRound()" id="startBtn">é–‹å§‹æœ¬å›åˆ</button>
                <button onclick="leaveRoom()">é›¢é–‹æˆ¿é–“</button>
            </div>
            
            <!-- è¼¸å…¥éšæ®µ -->
            <div id="inputSection" class="input-section hidden">
                <h3>è¼¸å…¥ä½ çš„æ•¸å­—</h3>
                <p>è«‹è¼¸å…¥ 1 åˆ° <span id="maxNumber"></span> ä¹‹é–“çš„æ•¸å­—</p>
                <p style="font-size: 12px; color: #888;">ğŸ’¡ æ‰€æœ‰äººçš„æ•¸å­—åŠ ç¸½å¾Œï¼Œç”¨ç¸½å’Œé™¤ä»¥äººæ•¸çš„é¤˜æ•¸ä¾†æ±ºå®šä¸­çè€…</p>
                <div class="number-input">
                    <input type="number" id="numberInput" min="1" max="1">
                    <button onclick="submitNumber()">æäº¤</button>
                    <span id="submitStatus"></span>
                </div>
            </div>
            
            <!-- ä¸»æŒäººæ­æ›‰æŒ‰éˆ• -->
            <div id="revealControls" class="controls hidden">
                <button onclick="revealResult()">æ­æ›‰çµæœ</button>
                <button onclick="forceReveal()">å¼·åˆ¶æ­æ›‰ï¼ˆæœªæäº¤è€…è¦–ç‚º0ï¼‰</button>
            </div>
            
            <!-- çµæœé¡¯ç¤º -->
            <div id="resultSection" class="result-section hidden">
                <h3>ğŸ‰ æŠ½ç±¤çµæœ</h3>
                <div class="winner-name" id="winnerName"></div>
                <div class="result-details" id="resultDetails"></div>
                <div class="controls">
                    <button onclick="backToLobby()" id="backBtn">è¿”å›å¤§å»³</button>
                </div>
            </div>
            
            <div id="roomError" class="error hidden"></div>
            <div id="roomSuccess" class="success hidden"></div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let isHost = false;
        let hasSubmitted = false;
        
        function joinRoom() {
            const roomName = document.getElementById('roomName').value.trim();
            const userName = document.getElementById('userName').value.trim();
            
            if (!roomName || !userName) {
                showError('loginError', 'è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œåå­—');
                return;
            }
            
            if (!socket) {
                socket = io();
                setupSocketListeners();
            }
            
            socket.emit('joinRoom', { roomName, userName });
        }
        
        function setupSocketListeners() {
            socket.on('joinSuccess', (data) => {
                currentUser = data.userName;
                currentRoom = data.roomName;
                isHost = data.isHost;
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('roomScreen').classList.remove('hidden');
                document.getElementById('currentRoom').textContent = currentRoom;
                
                updateRoomState(data.roomState);
            });
            
            socket.on('joinError', (message) => {
                showError('loginError', message);
            });
            
            socket.on('roomUpdate', (roomState) => {
                updateRoomState(roomState);
            });
            
            socket.on('kicked', () => {
                alert('ä½ å·²è¢«ä¸»æŒäººè¸¢å‡ºæˆ¿é–“');
                location.reload();
            });
            
            socket.on('numberSubmitted', () => {
                hasSubmitted = true;
                document.getElementById('submitStatus').textContent = 'âœ… å·²æäº¤';
                document.getElementById('numberInput').disabled = true;
            });
            
            socket.on('error', (message) => {
                showError('roomError', message);
            });
        }
        
        function updateRoomState(state) {
            // æ›´æ–°éšæ®µ
            const phaseText = {
                'lobby': 'å¾…æ©Ÿä¸­',
                'input': 'è¼¸å…¥æ•¸å­—ä¸­',
                'revealed': 'çµæœå·²æ­æ›‰'
            };
            document.getElementById('roomPhase').textContent = phaseText[state.phase];
            
            // æ›´æ–°ä¸»æŒäººè³‡è¨Š
            const hostInfo = state.participants.find(p => p.isHost);
            isHost = hostInfo && hostInfo.name === currentUser;
            document.getElementById('hostInfo').textContent = 
                `ä¸»æŒäººï¼š${hostInfo ? hostInfo.name : 'ç„¡'} ${isHost ? '(ä½ )' : ''}`;
            
            // æ›´æ–°åƒèˆ‡è€…åˆ—è¡¨
            const listEl = document.getElementById('participantList');
            listEl.innerHTML = '';
            document.getElementById('participantCount').textContent = state.participants.length;
            
            state.participants.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'participant';
                if (p.isHost) div.classList.add('host');
                if (!p.online) div.classList.add('offline');
                if (state.winner === p.name) div.classList.add('winner');
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'participant-name';
                nameSpan.textContent = `${index + 1}. ${p.name} ${p.name === currentUser ? '(ä½ )' : ''} ${p.isHost ? 'ğŸ‘‘' : ''}`;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'participant-status';
                
                const dot = document.createElement('div');
                dot.className = 'status-dot';
                if (!p.online) dot.classList.add('offline');
                
                statusDiv.appendChild(dot);
                
                // è¼¸å…¥éšæ®µé¡¯ç¤ºæäº¤ç‹€æ…‹
                if (state.phase === 'input' && state.submissions) {
                    const submitted = state.submissions[p.name];
                    const statusText = document.createElement('span');
                    statusText.textContent = submitted ? 'âœ…' : 'â³';
                    statusDiv.appendChild(statusText);
                }
                
                // ä¸»æŒäººå¯ä»¥è¸¢äººï¼ˆå¾…æ©Ÿéšæ®µï¼‰
                if (isHost && state.phase === 'lobby' && p.name !== currentUser) {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'kick-btn';
                    kickBtn.textContent = 'è¸¢å‡º';
                    kickBtn.onclick = () => kickUser(p.name);
                    statusDiv.appendChild(kickBtn);
                }
                
                div.appendChild(nameSpan);
                div.appendChild(statusDiv);
                listEl.appendChild(div);
            });
            
            // æ ¹æ“šéšæ®µé¡¯ç¤ºä¸åŒæ§åˆ¶
            hideAllControls();
            
            if (state.phase === 'lobby') {
                document.getElementById('lobbyControls').classList.remove('hidden');
                document.getElementById('startBtn').disabled = !isHost || state.participants.length < 2;
            } else if (state.phase === 'input') {
                document.getElementById('inputSection').classList.remove('hidden');
                document.getElementById('maxNumber').textContent = state.participants.length;
                document.getElementById('numberInput').min = 1;
                document.getElementById('numberInput').max = state.participants.length;
                
                if (!hasSubmitted) {
                    document.getElementById('numberInput').disabled = false;
                    document.getElementById('submitStatus').textContent = '';
                }
                
                if (isHost) {
                    document.getElementById('revealControls').classList.remove('hidden');
                }
            } else if (state.phase === 'revealed') {
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('winnerName').textContent = `ğŸ† ${state.winner}`;
                
                // é¡¯ç¤ºè©³ç´°çµæœ
                const detailsEl = document.getElementById('resultDetails');
                detailsEl.innerHTML = '';
                
                if (state.result) {
                    const items = [
                        { label: 'ç¸½å’Œ', value: state.result.total },
                        { label: 'åƒèˆ‡äººæ•¸', value: state.result.participantCount },
                        { label: 'è¨ˆç®—çµæœ', value: `${state.result.total} mod ${state.result.participantCount} = ${state.result.index}` },
                        { label: 'ä¸­çä½ç½®', value: `ç¬¬ ${state.result.index + 1} ä½` }
                    ];
                    
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerHTML = `
                            <span>${item.label}:</span>
                            <strong>${item.value}</strong>
                        `;
                        detailsEl.appendChild(div);
                    });
                    
                    // é¡¯ç¤ºå„äººæäº¤çš„æ•¸å­—
                    if (state.result.submissions) {
                        const subDiv = document.createElement('div');
                        subDiv.className = 'result-item';
                        subDiv.style.flexDirection = 'column';
                        subDiv.style.alignItems = 'flex-start';
                        subDiv.innerHTML = '<span>å„äººæäº¤:</span>';
                        
                        const subList = document.createElement('div');
                        subList.style.marginTop = '5px';
                        
                        for (const [name, value] of Object.entries(state.result.submissions)) {
                            const item = document.createElement('div');
                            item.textContent = `${name}: ${value}`;
                            item.style.marginLeft = '20px';
                            subList.appendChild(item);
                        }
                        
                        subDiv.appendChild(subList);
                        detailsEl.appendChild(subDiv);
                    }
                }
                
                document.getElementById('backBtn').disabled = !isHost;
            }
        }
        
        function hideAllControls() {
            document.getElementById('lobbyControls').classList.add('hidden');
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('revealControls').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        }
        
        function startRound() {
            socket.emit('startRound');
            hasSubmitted = false;
        }
        
        function submitNumber() {
            const input = document.getElementById('numberInput');
            const value = parseInt(input.value);
            
            if (isNaN(value) || value < 1 || value > parseInt(input.max)) {
                showError('roomError', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—ï¼ˆ1 åˆ° ' + input.max + 'ï¼‰');
                return;
            }
            
            socket.emit('submitNumber', value);
        }
        
        function revealResult() {
            socket.emit('revealResult');
        }
        
        function forceReveal() {
            socket.emit('forceReveal');
        }
        
        function backToLobby() {
            socket.emit('backToLobby');
            hasSubmitted = false;
        }
        
        function kickUser(userName) {
            if (confirm(`ç¢ºå®šè¦è¸¢å‡º ${userName} å—ï¼Ÿ`)) {
                socket.emit('kickUser', userName);
            }
        }
        
        function leaveRoom() {
            if (confirm('ç¢ºå®šè¦é›¢é–‹æˆ¿é–“å—ï¼Ÿ')) {
                location.reload();
            }
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        }
        
        // è™•ç†é é¢é—œé–‰/åˆ·æ–°
        window.addEventListener('beforeunload', () => {
            if (socket && currentRoom) {
                socket.emit('leaveRoom');
            }
        });
    </script>
</body>
</html>